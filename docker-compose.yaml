services:
  backend:
    build: ./backend
    ports:
      - "${BACKEND_PORT}:${BACKEND_PORT}"
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:${POSTGRES_PORT}/${POSTGRES_DB}
    depends_on:
      postgres:
        condition: service_healthy

  frontend:
    build: ./frontend
    volumes:
      - frontend-build:/app/dist

  nginx:
    build: ./nginx
    ports:
      - "${NGINX_PORT}:80"
    env_file:
      - .env
    depends_on:
      - frontend
    volumes:
      - frontend-build:/usr/share/nginx/html

  postgres:
    image: postgres:15-alpine
    container_name: social_hack_db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    env_file:
      - .env
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT}:5432"
    restart: unless-stopped

  init-data:
    image: postgres:15-alpine
    container_name: social_hack_init_data
    env_file:
      - .env
    volumes:
      - ./backend/init-data.sql:/tmp/init-data.sql:ro
    depends_on:
      backend:
        condition: service_started
      postgres:
        condition: service_healthy
    command: >
      sh -c "
      echo 'Waiting for backend to create tables...' &&
      until PGPASSWORD=$$POSTGRES_PASSWORD psql -h postgres -U $$POSTGRES_USER -d $$POSTGRES_DB -tAc \"SELECT 1 FROM information_schema.tables WHERE table_name='users'\" | grep -q 1; do
        echo 'Tables not ready yet, waiting...' &&
        sleep 2
      done &&
      echo 'Tables are ready! Executing init-data.sql...' &&
      PGPASSWORD=$$POSTGRES_PASSWORD psql -h postgres -U $$POSTGRES_USER -d $$POSTGRES_DB -f /tmp/init-data.sql &&
      echo 'Database initialization completed!'
      "
    restart: "no"

volumes:
  frontend-build:
  postgres_data:
